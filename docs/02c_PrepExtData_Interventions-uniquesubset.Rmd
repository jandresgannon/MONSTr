---
title: "02c_PrepExtData_InterventionList (nested)"
author: "J Andres Gannon"
date: "9/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(ggplot2)
library(plyr)
```

This document takes the complete list of US interventions and compares what cases are and are not covered by prior datasets.

# Load data
We load the googlesheet where the wikidata info for each US intervention was loaded
```{r}
df_raw <- googlesheets4::read_sheet(ss = "https://docs.google.com/spreadsheets/d/1wiiuNVE2Wt-ZWyZRWDoqyxvg-y-hWpNdDWwdZjYCvM4/edit#gid=487765801",
                                    sheet = "02c_interventions_newdata_list")
```
# Clean data
## Inspect
Each row represents an operation, battle, or campaign that is part of a US intervention.

# Coverage from prior datasets
We already know which wikidata items are covered by prior datasets, so we can identify that coverage here and then merge those covariates.
```{r}
prior <- googlesheets4::read_sheet(ss = "https://docs.google.com/spreadsheets/d/1wiiuNVE2Wt-ZWyZRWDoqyxvg-y-hWpNdDWwdZjYCvM4/edit#gid=487765801",
                                    sheet = "02b_interventions_priordata-all")

aerial_all <- readRDS(paste0(here::here(), "/data/AerialBombingCampaigns.rds"))
```

## Clean
Narrow the dataset to the columns of interest and drop those that we know aren't interventions and aren't on wikidata
```{r}
prior <- prior %>%
  dplyr::filter(drop == 0) %>%
  dplyr::select(dataset, wikidata_name, wikidata_id)

# Do the same for air power 
aerial_sub <- aerial_all[, c("war_wikidata_name", "cruise_platform", "platform_used", "allen", "horowitz")]
```

Create new dummy columns for each dataset
```{r}
prior$dataset <- as.factor(prior$dataset)
prior <- fastDummies::dummy_cols(prior, select_columns = "dataset")
prior$dataset <- NULL

prior <- prior %>%
  dplyr::distinct()

# Merge common rows
prior_temp <- prior %>%
  tidyr::pivot_longer(cols = dplyr::starts_with("dataset_"),
                      names_to = "dataset",
                      values_to = "contains") %>%
  dplyr::filter(contains == 1) %>%
  tidyr::pivot_wider(id_cols = dplyr::starts_with("wikidata_"),
                     names_from = "dataset",
                     values_from = "contains") %>%
  replace(is.na(.), 0)

prior_temp <- plyr::ddply(prior_temp, .(wikidata_id), summarize,
                          wikidata_name = paste(wikidata_name, collapse = ","),
                          dataset_icb = paste(dataset_icb, collapse = ","),
                          dataset_imi = paste(dataset_imi, collapse = ","),
                          dataset_mids = paste(dataset_mids, collapse = ","),
                          dataset_mip = paste(dataset_mip, collapse = ","),
                          dataset_mips = paste(dataset_mips, collapse = ","),
                          dataset_prio = paste(dataset_prio, collapse = ","),
                          dataset_rand = paste(dataset_rand, collapse = ","))

prior_temp <- prior_temp %>%
  dplyr::select(-wikidata_name)

## Format air power dataset
aerial_sub <- aerial_sub %>%
  dplyr::rename(wikidata_name = war_wikidata_name)

wide <- reshape2::dcast(aerial_sub, wikidata_name + allen + horowitz ~ cruise_platform, 
                        value.var = "platform_used", fill = 0, 
                        fun.aggregate = function(x) 1) %>%
  dplyr::select(-`NA`) 

#fix coding error
wide$wikidata_name <- gsub("Iraqi Kurdish civil war", "Iraqi Kurdish Civil War", wide$wikidata_name)

wide_fin <- wide %>%  
  dplyr::mutate(cruise = ifelse(wide$air == 1 |
                                wide$surface == 1 |
                                wide$`sub-surface` == 1, 1, 0)) %>%
  dplyr::select(wikidata_name, allen, horowitz) %>%
  dplyr::mutate(temp = rowSums(wide[,2:3])) %>%
  dplyr::group_by(wikidata_name) %>%
  dplyr::top_n(1) %>%
  dplyr::select(-temp) %>%
  dplyr::rename(dataset_allen = allen,
                dataset_horowitz = horowitz)

wide_fin$dataset_allen <- as.character(wide_fin$dataset_allen)
wide_fin$dataset_horowitz <- as.character(wide_fin$dataset_horowitz)
```

## Merge
Merge the one hot encodings of prior dataset coverage with the full dataframe of all values
```{r}
df <- df_raw

df <- dplyr::left_join(df, prior_temp, by = "wikidata_id")
df <- dplyr::full_join(df, wide_fin, by = "wikidata_name")

df <-df %>%
  dplyr::filter(!is.na(wikidata_id)) %>%
  dplyr::select(-notes) %>%
  replace(is.na(.), "0") %>%
  dplyr::mutate_at(c('dataset_icb', 'dataset_imi', 'dataset_mids', 'dataset_mip', 'dataset_mips', 'dataset_prio', 'dataset_rand', 'dataset_allen', 'dataset_horowitz'), as.numeric)
```

## Table
We can now compare the interventions covered by prior datasets with those covered by ours
```{r}
coverage <- df

# Create identifier variable for our dataset
coverage$dataset_new <- 1

# Drop unnecessary columns to make it easier to read
coverage$wikidata_id <- NULL

# Convert NAs to 0 to make table easier to read

# Clean column names
names(coverage) <- sub(".*_", "", colnames(coverage))

# Sort numerically
coverage <- coverage[order(coverage$name, decreasing = FALSE), ]

# Make html table
formattable::formattable(coverage,
                         align = c("c", "c", "c", "c", "c", "c", "c", "c"),
                         list('icb' = formattable::color_tile("transparent", "lightblue"),
                              'imi' = formattable::color_tile("transparent", "lightblue"),
                              'mids' = formattable::color_tile("transparent", "lightblue"),
                              'mip' = formattable::color_tile("transparent", "lightblue"),
                              'mips' = formattable::color_tile("transparent", "lightblue"),
                              'prio' = formattable::color_tile("transparent", "lightblue"),
                              'rand' = formattable::color_tile("transparent", "lightblue"),
                              'allen' = formattable::color_tile("transparent", "lightblue"),
                              'horowitz' = formattable::color_tile("transparent", "lightblue"),
                              'new' = formattable::color_tile("transparent", "lightblue")))

colSums(coverage[ , c(2:11)])
```

## Plot
```{r}
# Prep data for upset plot
upset_full <- coverage %>%
  dplyr::rename("ICB" = icb,
                "MIDS" = mids,
                "IMI" = imi,
                "MIP" = mip,
                "MIPS" = mips,
                "RAND" = rand,
                "PRIO" = prio,
                "Allen 2018" = allen,
                "Horowitz 2001" = horowitz,
                "New Dataset" = new)
upset_full[is.na(upset_full)] <- 0
upset_full <- as.data.frame(upset_full)

upset_old <- upset_full %>% dplyr::select(-"New Dataset", -"Allen 2018", -"Horowitz 2001")

upset_old_and_aerial <- upset_full %>% dplyr::select(-"New Dataset")


# Coverage for just previous datasets
png(file = paste0(here::here(), '/paper/figures/summary_stats/coverage_previous_datasets.png'),
    width = 1600,
    height = 1200,
    res = 120)
UpSetR::upset(upset_old,
      nsets = 6, number.angles = 0, point.size = 3.5, line.size = 2, text.scale = 2.2,
      mainbar.y.label = "Number of Interventions", sets.x.label = "Total Observations", order.by = "freq")

grid::grid.text(
  "",
  x = 0.70,
  y = 0.02,
  gp = grid::gpar(
    fontsize = 14,
    fontface = 3
  )
)

grid::grid.edit('arrange', name="upset_old")

vp <- grid::grid.grab()
gridExtra::grid.arrange(
  grobs = list(
    vp
  ),
  top=grid::textGrob("Comparison of Dataset Coverage: US Military Interventions (1991-Present)", gp=grid::gpar(fontsize = 16)),
  fontsize = 16,
  cols=1
)
dev.off()


# Upset for previous data and aerial bombing
png(file = paste0(here::here(), '/paper/figures/summary_stats/coverage_previous_datasets_aerial_bombing.png'),
    width = 1600,
    height = 1200,
    res = 120)

UpSetR::upset(upset_old_and_aerial,
      nsets = 8, number.angles = 0, point.size = 3.5, line.size = 2, text.scale = 2.2,
      mainbar.y.label = "Number of Interventions", sets.x.label = "Total Observations", order.by = "freq")

grid::grid.text(
  "",
  x = 0.70,
  y = 0.02,
  gp = grid::gpar(
    fontsize = 14,
    fontface = 3
  )
)

grid::grid.edit('arrange', name="upset_old_and_aerial")

vp <- grid::grid.grab()
gridExtra::grid.arrange(
  grobs = list(
    vp
  ),
  top=grid::textGrob("Comparison of Dataset Coverage: US Military Interventions (1991-Present)", gp=grid::gpar(fontsize = 16)),
  fontsize = 16,
  cols=1
)
dev.off()


# Upset of all data
png(file = paste0(here::here(), '/paper/figures/summary_stats/coverage_all_datasets.png'),
    width = 1600,
    height = 1200,
    res = 120)

UpSetR::upset(upset_full,
      nsets = 9, number.angles = 0, point.size = 3.5, line.size = 2, text.scale = 2.2,
      mainbar.y.label = "Number of Interventions", sets.x.label = "Total Observations", order.by = "freq")

grid::grid.text(
  "",
  x = 0.70,
  y = 0.02,
  gp = grid::gpar(
    fontsize = 14,
    fontface = 3
  )
)

grid::grid.edit('arrange', name="upset_full")

vp <- grid::grid.grab()
gridExtra::grid.arrange(
  grobs = list(
    vp
  ),
  top=grid::textGrob("Comparison of Dataset Coverage: US Military Interventions (1991-Present)", gp=grid::gpar(fontsize = 16)),
  fontsize = 16,
  cols=1
)
dev.off()

```

# Add covariates
## Prior datasets
Prior datasets only covered a limited number of cases, but do have covariates that are worth drawing from. We'll first identify the covariates of interest, then subset each prior dataset to those covariates, then merge again using wikidata Q codes.
```{r}
# Wikidata coding to merge observations
qcodes <- googlesheets4::read_sheet(ss = "https://docs.google.com/spreadsheets/d/1wiiuNVE2Wt-ZWyZRWDoqyxvg-y-hWpNdDWwdZjYCvM4/edit#gid=221751876",
                                sheet = "02b_interventions_priordata-all")

# Prior datasets
## Interventions
icb <- read.csv(paste0(here::here(),"/inst/extdata/icb2v12.csv"))
imi <- read.csv(paste0(here::here(),"/inst/extdata/IMI/IMI_dataset.csv"))
mips <- read.csv(paste0(here::here(),"/inst/extdata/MIPS/MIPS_dataset.csv"))
prio <- read.csv(paste0(here::here(),"/inst/extdata/PRIO/UCDP-PRIO_armed_conflict_dataset.csv"))
mids <- read.csv(paste0(here::here(),"/inst/extdata/MIDs/MIDs_dispute-participants.csv"))

# Aerial bombing
allen_17 <- readstata13::read.dta13("../inst/extdata/AllenMtzMachainAerialBombingData2016CMPS.dta")
horowitz_01 <- foreign::read.dta("../inst/extdata/jcr01.dta")
amm_18 <- readstata13::read.dta13("../inst/extdata/ReplicationAllenMartinezMachainJOGSS.dta")

# Cruise missiles
cruise <- readRDS(file = paste0(here::here(), '/data/CruiseMissiles.rds'))
cruise_campaign <- readRDS(file = paste0(here::here(), '/data/CruiseMissilesCampaign.rds')) 
cruise_crisis <- readRDS(file = paste0(here::here(), '/data/CruiseMissilesCrisis.rds')) 

# left_join each prior dataset into df

```

## Cruise missiles
New data collected on cruise missiles allows us to dummy variable whether or not a given event had cruise missiles.


# Save final data
```{r}
# Save
write.csv(df, paste0(here::here(), "/data/","02c_interventions_newdata_merged.csv"))
```