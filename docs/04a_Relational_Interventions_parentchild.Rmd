---
title: "04a Relational Interventions (Parent-child relationships)"
author: "J Andres Gannon"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output:
  bookdown::html_notebook2:
    fig_height: 8
    fig_width: 12
    number_sections: yes
    code_folding: hide
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
  bookdown::word_document:
    toc: no
    toc_depth: '5'
  bookdown::pdf_document2:
    toc: yes
    toc_depth: '5'
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: '5'
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE}
library(magrittr)
library(ggplot2)
options(scipen = 999)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE)
```

# Load data
We load the googlesheet where the wikidata info for each US intervention was loaded
```{r}
df_raw <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1wiiuNVE2Wt-ZWyZRWDoqyxvg-y-hWpNdDWwdZjYCvM4/edit?usp=sharing",
                                    sheet = "04a_interventions_newdata_childof")
```

# Clean data
Identify the values in childof column that are not in wikidata name. If this list is blank, the data is in good shape.
```{r}
as.data.frame(unique(df_raw$childof_name[!(df_raw$childof_name %in% df_raw$wikidata_name)]))
```

# Visualize
Show parent-child dependencies so we know what military operations are clustered/networked together
```{r}
# Subset to just named columns
df <- df_raw %>% 
  dplyr::select(wikidata_name, childof_name, realparent) %>%
  dplyr::filter(realparent == 1 |
                  is.na(realparent)) %>%
  dplyr::distinct() %>%
  dplyr::select(-realparent)
```

## Dependency network
```{r}
# Network
## Network package
network <- network::network(df, directed = T, multiple = T, bipartite = F)

## D3 package
networkD3::simpleNetwork(df,
                         zoom = T,
                         linkColour = "gray",
                         opacity = 1,
                         charge = -2,
                         fontSize = 0)

# Tree
df <- df_raw %>%
  dplyr::filter(!childof_name == "NA")

## collapsibleTree package
df %>% collapsibleTree::collapsibleTree(hierarchy = c("childof_name", "wikidata_name"), 
                                   height = 10000, width = 1000, 
                                   collapse = FALSE, zoomable = FALSE)

```

# Subset to just youngest child nodes
We want to avoid double-counting interventions, which means we don't want to include any intervention that nests other interventions within it. We can do this by dropping any node that is a parent
```{r}
df_parent <- df_raw %>%
  dplyr::select(childof_name) %>%
  dplyr::mutate(parent = 1)

df_child <- df_raw %>%
  dplyr::select(wikidata_name)

df_childonly <- dplyr::left_join(df_child, df_parent, by = c("wikidata_name" = "childof_name")) %>%
  dplyr::distinct() %>%
  dplyr::filter(is.na(parent))

write.csv(df_childonly, paste0(here::here(), "/data/","04a_intervention_newdata_childonly.csv"))
```

# Means (Child-only Data)
## Prep
We use a version of the data that is only interventions with no children. That eliminates redundant counts since there are no observations for interventions for which we have other interventions that make it up. For example, we don't need an observation for the Iraq War if we have observations for the interventions that are subsets of the Iraq War

Prep the means data by subsetting to just the DV variables and renaming them for easier human readings
```{r}
# Load original with means
df_og <- read.csv(paste0(here::here(), "/data/","03a_intervention_newdata_dbpedia.csv"))

# Subset
df_og <- df_og %>%
  dplyr::select(wikidata_name, dplyr::starts_with("means_")) %>%
  dplyr::distinct()

# Merge
df_childonly <- dplyr::left_join(df_childonly, df_og) %>%
  dplyr::select(-parent)

# Clean by converting to 0's
df_childonly[is.na(df_childonly)] <- 0

# For now, drop the rows where we don't know the means so the null counts are not off
df_childonly <- df_childonly[rowSums(df_childonly[2:8]) > 0, ]

# Rename columns
df_childonly <- df_childonly %>% 
  dplyr::mutate(unrisk_trunc = ((means_groundtroops * 1 + 
                                   means_closeairsupport * 2 +
                                   means_paramilitary * 3 +
                                   means_airtoair * 4 +
                                   means_aerialbombing * 5 +
                                   means_cruisemissiles * 6 +
                                   means_drones * 7)/
                                  (means_groundtroops +
                                     means_closeairsupport +
                                     means_paramilitary +
                                     means_airtoair +
                                     means_aerialbombing +
                                     means_cruisemissiles +
                                     means_drones
                                   )
                                )
                ) %>%
  dplyr::rename("Risk" = unrisk_trunc,
                "Aerial bombing" = means_aerialbombing, 
                "Air-to-air" = means_airtoair, 
                "Close Air Support" = means_closeairsupport, 
                "Cruise missiles" = means_cruisemissiles, 
                "Drones" = means_drones, 
                "Ground troops" = means_groundtroops, 
                "Paramilitary" = means_paramilitary)
```

## Table
```{r}
df_childonly %>% 
  dplyr::select(-Risk) %>%
  tidyr::gather(wikidata_name, means) %>%
  dplyr::count(wikidata_name, means) %>%
  dplyr::filter(means == 1) %>%
  dplyr::select(-means) %>%
  DT::datatable()
```

## Plot
```{r}
df_childonly %>% 
  dplyr::select(-Risk) %>%
  tidyr::gather(wikidata_name, means) %>%
  dplyr::count(wikidata_name, means) %>%
  dplyr::filter(means == 1) %>%
  dplyr::select(-means) %>%
  ggplot(aes(x = wikidata_name, y = n)) + 
  geom_bar(stat = "identity") +
  labs(title = "Means of US Interventions (1991-2019)", x = "Means", y = "Event Count") +
  geom_text(aes(label = n), vjust = -0.5, size = 6) +
  theme_bw() +
  lims(y = c(0, 250)) +
  scale_x_discrete(labels = c("means_aerialbombing" = "Aerial bombing", 
                              "means_airtoair" = "Air-to-air", 
                              "means_closeairsupport" = "Close Air Support", 
                              "means_cruisemissiles" = "Cruise missiles", 
                              "means_drones" = "Drones", 
                              "means_groundtroops" = "Ground troops", 
                              "means_paramilitary" = "Paramilitary")) +
  theme(plot.title = element_text(),panel.grid = element_blank(),
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1))

ggsave(paste0(here::here(),"/paper/figures/summary_stats/means_counts.png"), height = 8, width = 16, units = "in")
```

## Visualize combos
```{r, fig.width = 16, fig.height = 16}
dv <- df_childonly %>% 
  dplyr::select(-wikidata_name)

dv <- as.data.frame(sapply(dv, as.numeric))

UpSetR::upset(dv,
      number.angles = 0, point.size = 3, line.size = 1, text.scale = 2,
      mainbar.y.label = "Number of Interventions", order.by = "freq", set_size.show = TRUE, set_size.scale_max = 250)
```

# Distribution of scores
```{r}
df_childonly %>%
  dplyr::select(wikidata_name, Risk) %>%
  ggplot(aes(x = Risk)) + 
  geom_histogram() + 
  labs(title = "Intervention Risk", x = "Weighted Index", y = "Number of Interventions") +
  theme_bw()
```

# Save
The dataframe now represents a correct nesting of the US interventions identified by prior datasets (ICB, IMI, MIPS, PRIO, MIDS, and RAND). Although it initially appeared that they had vastly different coverage of US interventions, much of those differences can be attributed to inconsistencies in the unit of analysis between and within datasets.
```{r}
write.csv(df_childonly, paste0(here::here(), "/data/","03c_intervention_newdata_childof.csv"))
```